using System;
using System.Windows;
using System.Windows.Media;
using System.Windows.Media.Animation;
using System.Windows.Threading;

namespace YourNamespace
{
    public partial class MainWindow : Window
    {
        private DispatcherTimer _timer;
        private DateTime _startTime; // Track start time for precise elapsed time
        private TimeSpan _totalTime;
        
        private int _batteryState = 0;
        private readonly Color[] _batteryColors = { Colors.Red, Colors.Yellow, Colors.Green };
        private readonly double[] _batteryHeights = { 0.2, 0.6, 1.0 };
        private DispatcherTimer _batteryTimer;
        
        public MainWindow()
        {
            InitializeComponent();
            
            ProgressIndicator.Fill = new SolidColorBrush(Colors.DodgerBlue);
            BatteryBar.Fill = new SolidColorBrush(Colors.LightGreen);
            
            Loaded += (s, e) => {
                InitProgressAnimation();
                InitBatteryAnimation();
            };
        }
        
        private void InitProgressAnimation()
        {
            _totalTime = TimeSpan.FromSeconds(5);
            _startTime = DateTime.Now; // Initialize start time
            
            // 20ms interval for smooth progress bar animation
            _timer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(20) };
            _timer.Tick += (s, e) => {
                TimeSpan elapsed = DateTime.Now - _startTime;
                
                if (elapsed >= _totalTime)
                {
                    TimeDisplay.Text = "00:00:00";
                    UpdateProgressBar(100);
                    _startTime = DateTime.Now; // Reset start time
                    TimeDisplay.Text = _totalTime.ToString(@"hh\:mm\:ss");
                    UpdateProgressBar(0);
                }
                else
                {
                    double progress = (elapsed.TotalMilliseconds / _totalTime.TotalMilliseconds) * 100;
                    progress = Math.Min(progress, 100); // Cap at 100%
                    
                    // Update time display only when seconds change
                    TimeSpan remaining = _totalTime - elapsed;
                    TimeSpan prevRemaining = remaining + _timer.Interval;
                    if (prevRemaining.Seconds != remaining.Seconds)
                    {
                        TimeDisplay.Text = remaining.ToString(@"hh\:mm\:ss");
                    }
                    
                    UpdateProgressBar(progress);
                }
            };
            _timer.Start();
        }
        
        private void UpdateProgressBar(double progress)
        {
            if (ProgressBackground.ActualWidth > 0)
            {
                ProgressIndicator.Width = progress * ProgressBackground.ActualWidth / 100;
                ProgressText.Text = $"{Math.Round(progress)}%";
            }
        }
        
        private void InitBatteryAnimation()
        {
            _batteryTimer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(2) };
            _batteryTimer.Tick += (s, e) => {
                _batteryState = (_batteryState + 1) % 3;
                
                double containerHeight = BatteryContainer.ActualHeight;
                
                Storyboard storyboard = new Storyboard();
                
                ColorAnimation colorAnim = new ColorAnimation {
                    To = _batteryColors[_batteryState],
                    Duration = TimeSpan.FromSeconds(0.5)
                };
                Storyboard.SetTarget(colorAnim, BatteryBar);
                Storyboard.SetTargetProperty(colorAnim, new PropertyPath("(Shape.Fill).(SolidColorBrush.Color)"));
                storyboard.Children.Add(colorAnim);
                
                // Animate height for smoother battery transition
                DoubleAnimation heightAnim = new DoubleAnimation {
                    To = containerHeight * _batteryHeights[_batteryState],
                    Duration = TimeSpan.FromSeconds(0.5)
                };
                Storyboard.SetTarget(heightAnim, BatteryBar);
                Storyboard.SetTargetProperty(heightAnim, new PropertyPath("Height"));
                storyboard.Children.Add(heightAnim);
                
                storyboard.Begin(this);
            };
            _batteryTimer.Start();
        }
        
        protected override void OnClosing(System.ComponentModel.CancelEventArgs e)
        {
            _timer?.Stop();
            _batteryTimer?.Stop();
            base.OnClosing(e);
        }
    }
}
